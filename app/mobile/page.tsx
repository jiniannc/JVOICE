"use client"

import React, { useState, useEffect } from "react"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Badge } from "@/components/ui/badge"
import { 
  Upload, 
  FileText, 
  User, 
  LogIn, 
  ArrowLeft,
  Mic,
  History,
  Monitor,
  X,
  Loader2,
  LogOut,
  Music,
  BookOpen
} from "lucide-react"
import { FileUploadEvaluation } from "@/components/file-upload-evaluation"
import { GoogleAuth } from "@/components/google-auth"
import { employeeDB } from "@/lib/employee-database"
import { MobileReviewPage } from "@/components/mobile-review-page"

interface UserInfo {
  name: string
  employeeId: string
  language: string
  category: string
  email?: string
  broadcastCode?: string
  teamNumber?: string
  role?: string
  broadcastGrade?: string
  isInstructor?: boolean
  isAdmin?: boolean
  roles?: string[]
  department?: string
  position?: string
}

interface AuthenticatedUser {
  email: string
  name: string
  picture: string
  role: string
  broadcastCode: string
  teamNumber: string
  broadcastGrade: string
  isTestAccount?: boolean
}

export default function MobilePage() {
  // CSS ÌÇ§ÌîÑÎ†àÏûÑ Ïï†ÎãàÎ©îÏù¥ÏÖò Ï†ïÏùò
  React.useEffect(() => {
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideInFade {
        from {
          opacity: 0;
          transform: translateX(12px) scale(0.98);
        }
        to {
          opacity: 1;
          transform: translateX(0) scale(1);
        }
      }
      @keyframes typeWriter {
        from { width: 0; }
        to { width: 100%; }
      }
      @keyframes attentionPulse {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.5); }
        50% { transform: scale(1.015); box-shadow: 0 0 0 10px rgba(249, 115, 22, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(249, 115, 22, 0); }
      }
      @keyframes subtleFloat {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-2px); }
      }
      @keyframes gradientShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }
      .attention-pulse { animation: attentionPulse 1.3s ease-out infinite; }
      .subtle-float { animation: subtleFloat 3s ease-in-out infinite; }
      .gradient-shift { 
        background-size: 200% 200%;
        animation: gradientShift 4s ease infinite;
      }
      .card-hover {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .card-hover:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      }
    `;
    document.head.appendChild(style);
    return () => {
      if (document.head.contains(style)) {
        document.head.removeChild(style);
      }
    };
  }, []);

  const [authenticatedUser, setAuthenticatedUser] = useState<AuthenticatedUser | null | undefined>(undefined)
  const [userInfo, setUserInfo] = useState<UserInfo>({ name: "", employeeId: "", language: "", category: "" })
  const [showLoginModal, setShowLoginModal] = useState(false)
  const [showFileUpload, setShowFileUpload] = useState(false)
  const [showReview, setShowReview] = useState(false)
  const [showMyPage, setShowMyPage] = useState(false)
  const [pendingAction, setPendingAction] = useState<string | null>(null)
  const [isLoggingOut, setIsLoggingOut] = useState(false)
  const [isPageLoaded, setIsPageLoaded] = useState(false)
  const [recentSubmission, setRecentSubmission] = useState<any>(null)
  const [loadingSubmission, setLoadingSubmission] = useState(false)
  const [statusMessageKey, setStatusMessageKey] = useState(0) // Î©îÏãúÏßÄ Î≥ÄÍ≤Ω Í∞êÏßÄÏö©

  // ÏµúÍ∑º Ï†úÏ∂ú ÎÇ¥Ïó≠ Í∞ÄÏ†∏Ïò§Í∏∞
  const fetchRecentSubmission = async (employeeId: string, clearCache = false) => {
    if (!employeeId) return;
    
    setLoadingSubmission(true);
    try {
      const cacheParam = clearCache ? "&clearCache=true" : "";
      const response = await fetch(`/api/evaluations/load-my-recordings?employeeId=${employeeId}${cacheParam}`);
      const data = await response.json();
      
      if (data.success && data.records && data.records.length > 0) {
        // Í∞ÄÏû• ÏµúÍ∑º Ï†úÏ∂ú ÎÇ¥Ïó≠ Ï∞æÍ∏∞
        const sortedRecords = data.records.sort((a: any, b: any) => 
          new Date(b.submittedAt).getTime() - new Date(a.submittedAt).getTime()
        );
        
        console.log('üîç [Î™®Î∞îÏùº] ÏµúÍ∑º Ï†úÏ∂ú ÎÇ¥Ïó≠:', sortedRecords[0]);
        console.log('üîç [Î™®Î∞îÏùº] ÏÉÅÌÉú Ï†ïÎ≥¥:', {
          status: sortedRecords[0].status,
          approved: sortedRecords[0].approved,
          submittedAt: sortedRecords[0].submittedAt,
          totalScore: sortedRecords[0].totalScore,
          grade: sortedRecords[0].grade
        });
        
        // ÏÉÅÌÉú Î©îÏãúÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞
        const testMessage = getStatusMessage();
        console.log('üîç [Î™®Î∞îÏùº] ÏÉÅÌÉú Î©îÏãúÏßÄ:', testMessage);
        
        setRecentSubmission(sortedRecords[0]);
      } else {
        setRecentSubmission(null);
      }
    } catch (error) {
      console.error("ÏµúÍ∑º Ï†úÏ∂ú ÎÇ¥Ïó≠ Î°úÎìú Ïã§Ìå®:", error);
      setRecentSubmission(null);
    } finally {
      setLoadingSubmission(false);
    }
  };

  // ÏÉÅÌÉúÏóê Îî∞Î•∏ Î©îÏãúÏßÄ ÏÉùÏÑ±
  const getStatusMessage = () => {
    if (loadingSubmission) {
      return {
        icon: "‚è≥",
        title: "Ï†úÏ∂ú ÎÇ¥Ïó≠ ÌôïÏù∏ Ï§ë...",
        message: "ÏµúÍ∑º ÌèâÍ∞Ä ÏùëÏãú Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Í≥† ÏûàÏäµÎãàÎã§.",
      };
    }

    if (!recentSubmission) {
      return {
        icon: "üé§",
        title: "ÌèâÍ∞Ä ÏùëÏãú ÎåÄÍ∏∞",
        message: "ÏïÑÏßÅ ÌèâÍ∞ÄÏóê ÏùëÏãúÌïòÏßÄ ÏïäÏúºÏÖ®ÏäµÎãàÎã§."
      };
    }

    const submittedDate = new Date(recentSubmission.submittedAt);
    const formatDate = (date: Date) => {
      return date.toLocaleDateString("ko-KR", {
        year: "numeric",
        month: "long",
        day: "numeric"
      });
    };

    // ÏÉÅÌÉúÏóê Îî∞Î•∏ Î©îÏãúÏßÄ Í≤∞Ï†ï (Îã®ÏàúÌôî: ÌèâÍ∞Ä ÏôÑÎ£å vs ÌèâÍ∞Ä ÎåÄÍ∏∞Ï§ë)
    if (recentSubmission.approved) {
      return {
        icon: "üéâ",
        title: "ÌèâÍ∞Ä ÏôÑÎ£å",
        message: `${formatDate(submittedDate)}Ïûê ÏùëÏãú ÎÇ¥Ïó≠Ïùò ÌèâÍ∞ÄÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§. ÏßÄÍ∏à Î∞îÎ°ú Í≤∞Í≥ºÎ•º ÌôïÏù∏Ìï¥ Î≥¥ÏÑ∏Ïöî!`
      };
    } else {
      // pending, submitted, review_requested ÏÉÅÌÉú Î™®Îëê "ÌèâÍ∞Ä ÎåÄÍ∏∞Ï§ë"ÏúºÎ°ú ÌÜµÌï©
      return {
        icon: "‚è∞",
        title: "ÌèâÍ∞Ä ÎåÄÍ∏∞Ï§ë",
        message: `${formatDate(submittedDate)}Ïóê ÌèâÍ∞ÄÏóê ÏùëÏãúÌïòÏÖ®Í≥†, ÌòÑÏû¨ ÌèâÍ∞Ä ÎåÄÍ∏∞Ï§ëÏûÖÎãàÎã§.`
      };
    }
  };

  const shouldEmphasizeReviewCard = React.useMemo(() => {
    const msg = getStatusMessage();
    return msg.title === 'ÌèâÍ∞Ä ÏôÑÎ£å';
  }, [recentSubmission, loadingSubmission]);

  // ÏÑúÎ≤ÑÏÇ¨Ïù¥Îìú Ïù∏Ï¶ù ÏÉÅÌÉú ÌôïÏù∏
  useEffect(() => {
    const fetchUser = async () => {
      try {
        const res = await fetch("/api/auth/user")
        const data = await res.json()
        if (data.authenticated && data.user) {
          setAuthenticatedUser(data.user)
          // ÏßÅÏõê Ï†ïÎ≥¥ Î∂àÎü¨Ïò§Í∏∞
          const employeeInfo = await employeeDB.findEmployeeByEmail(data.user.email)
          if (employeeInfo) {
            setUserInfo((prev) => ({
              ...prev,
              name: employeeInfo.name,
              employeeId: employeeInfo.employeeId,
              department: employeeInfo.department,
              position: employeeInfo.position,
              email: data.user.email,
              isInstructor: employeeInfo.isInstructor,
              isAdmin: employeeInfo.isAdmin,
              roles: employeeInfo.roles,
            }))
          } else {
            setUserInfo((prev) => ({
              ...prev,
              name: data.user.name,
              employeeId: "",
              email: data.user.email,
              isInstructor: false,
              isAdmin: false,
              roles: [],
            }))
          }
        } else {
          setAuthenticatedUser(null)
        }
      } catch (e) {
        setAuthenticatedUser(null)
      }
    }
    fetchUser()
  }, [])

  // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Í∞Ä Î°úÎìúÎêú ÌõÑ ÏµúÍ∑º Ï†úÏ∂ú ÎÇ¥Ïó≠ Í∞ÄÏ†∏Ïò§Í∏∞
  useEffect(() => {
    if (userInfo.employeeId && authenticatedUser) {
      fetchRecentSubmission(userInfo.employeeId);
    }
  }, [userInfo.employeeId, authenticatedUser]);

  // ÏÉÅÌÉú Î©îÏãúÏßÄ Î≥ÄÍ≤Ω Ïãú Ïï†ÎãàÎ©îÏù¥ÏÖò Ìä∏Î¶¨Í±∞
  useEffect(() => {
    setStatusMessageKey(prev => prev + 1);
  }, [recentSubmission, loadingSubmission]);

  // ÌéòÏù¥ÏßÄ Î°úÎìú Ïï†ÎãàÎ©îÏù¥ÏÖò
  useEffect(() => {
    const timer = setTimeout(() => {
      setIsPageLoaded(true)
    }, 100)
    return () => clearTimeout(timer)
  }, [])

  const handleAuthSuccess = async (user: AuthenticatedUser) => {
    setAuthenticatedUser(user)

    // ÏßÅÏõê Ï†ïÎ≥¥ Î∂àÎü¨Ïò§Í∏∞
    const employeeInfo = await employeeDB.findEmployeeByEmail(user.email)
    if (employeeInfo) {
      setUserInfo((prev) => ({
        ...prev,
        name: employeeInfo.name,
        employeeId: employeeInfo.employeeId,
        department: employeeInfo.department,
        position: employeeInfo.position,
        email: user.email,
        isInstructor: employeeInfo.isInstructor,
        isAdmin: employeeInfo.isAdmin,
        roles: employeeInfo.roles,
      }))
    } else {
      setUserInfo((prev) => ({
        ...prev,
        name: user.name,
        employeeId: "",
        email: user.email,
        isInstructor: false,
        isAdmin: false,
        roles: [],
      }))
    }
    setShowLoginModal(false)

    // Î°úÍ∑∏Ïù∏ ÌõÑ ÎåÄÍ∏∞ Ï§ëÏù∏ Ïï°ÏÖò Ïã§Ìñâ
    if (pendingAction) {
      if (pendingAction === "fileUpload") {
        setShowFileUpload(true)
      } else if (pendingAction === "review") {
        setShowReview(true)
      }
      setPendingAction(null)
    }
  }

  const handleCardClick = (action: string, event?: React.MouseEvent) => {
    console.log("üéØ [MobilePage] handleCardClick Ìò∏Ï∂úÎê®:", action, "Ïù¥Î≤§Ìä∏ ÌÉÄÍ≤ü:", event?.target)
    
    // Ïù¥Î≤§Ìä∏ Î≤ÑÎ∏îÎßÅ Î∞©ÏßÄ
    if (event) {
      event.stopPropagation()
      event.preventDefault()
    }
    
    if (!authenticatedUser) {
      console.log("üîê [MobilePage] Î°úÍ∑∏Ïù∏ ÌïÑÏöî, pendingAction ÏÑ§Ï†ï:", action)
      setPendingAction(action)
      setShowLoginModal(true)
    } else {
      console.log("‚úÖ [MobilePage] Î°úÍ∑∏Ïù∏Îê®, Ïï°ÏÖò Ïã§Ìñâ:", action)
      if (action === "fileUpload") {
        setShowFileUpload(true)
      } else if (action === "review") {
        setShowReview(true)
      }
    }
  }

  const handleBack = () => {
    setShowFileUpload(false)
    setShowReview(false)
  }

  const handleLogout = async () => {
    console.log("üö® [MobilePage] Î°úÍ∑∏ÏïÑÏõÉ ÏãúÏûë")
    setIsLoggingOut(true)

    try {
      localStorage.clear()
      sessionStorage.clear()

      setAuthenticatedUser(null)
      setUserInfo({ name: "", employeeId: "", language: "", category: "" })
      setShowMyPage(false)

      // Î°úÍ∑∏ÏïÑÏõÉ API Ìò∏Ï∂ú
      await fetch("/api/auth/logout", { method: "POST" })
      
      console.log("‚úÖ [MobilePage] Î°úÍ∑∏ÏïÑÏõÉ ÏôÑÎ£å")
    } catch (error) {
      console.error("‚ùå [MobilePage] Î°úÍ∑∏ÏïÑÏõÉ Ïã§Ìå®:", error)
    } finally {
      setIsLoggingOut(false)
    }
  }

  const handleFileUploadComplete = (evaluationData: any) => {
    setShowFileUpload(false)
    // ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú
    const successMessage = document.createElement('div')
    successMessage.className = 'fixed top-4 left-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-lg z-50'
    successMessage.innerHTML = `
      <div class="flex items-center gap-2">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
        </svg>
        <span>ÎÖπÏùå ÌååÏùºÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†úÏ∂úÎêòÏóàÏäµÎãàÎã§!</span>
      </div>
    `
    document.body.appendChild(successMessage)
    
    // 3Ï¥à ÌõÑ Î©îÏãúÏßÄ Ï†úÍ±∞
    setTimeout(() => {
      if (document.body.contains(successMessage)) {
        document.body.removeChild(successMessage)
      }
    }, 3000)
  }

  if (showFileUpload) {
    return (
      <div className="min-h-screen bg-gray-50">
        <div className="bg-white shadow-sm border-b px-4 py-3 flex items-center gap-3">
          <Button
            onClick={handleBack}
            variant="ghost"
            size="sm"
            className="p-2"
          >
            <ArrowLeft className="w-5 h-5" />
          </Button>
          <h1 className="text-lg font-semibold">ÎÖπÏùå ÌååÏùº Ï†úÏ∂ú</h1>
        </div>
        <FileUploadEvaluation
          onComplete={handleFileUploadComplete}
          onBack={handleBack}
          authenticatedUser={authenticatedUser}
          hideHeader={true}
        />
      </div>
    )
  }

  if (showReview) {
    return (
      <MobileReviewPage 
        userInfo={userInfo} 
        onBack={handleBack} 
      />
    )
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50">
      {/* Ìó§Îçî */}
      <div className={`bg-gradient-to-b from-white/80 via-white/60 to-transparent backdrop-blur-sm px-6 py-6 transition-all duration-700 ${
        isPageLoaded ? 'translate-y-0 opacity-100' : '-translate-y-4 opacity-0'
      }`}>
        <div className="flex items-center justify-between max-w-4xl mx-auto">
          <div className="flex items-center gap-4">
            <h1 className={`text-3xl font-black bg-gradient-to-r from-blue-700 via-indigo-700 to-purple-700 bg-clip-text text-transparent tracking-tight transition-all duration-1000 ${
              isPageLoaded ? 'scale-100 opacity-100' : 'scale-95 opacity-0'
            }`}>
              JVOICE
            </h1>
            <Badge className={`bg-gradient-to-r from-purple-600 to-pink-600 text-white border-0 text-xs font-bold px-3 py-1 shadow-lg transition-all duration-1000 delay-200 ${
              isPageLoaded ? 'translate-x-0 opacity-100' : 'translate-x-2 opacity-0'
            }`}>
              Î™®Î∞îÏùº
            </Badge>
          </div>
          {authenticatedUser ? (
            <div className="flex items-center gap-3">
              <button
                onClick={(e) => {
                  e.stopPropagation()
                  e.preventDefault()
                  setShowMyPage(true)
                }}
                className="flex items-center gap-3 hover:scale-105 transition-all duration-300 group"
              >
                <div className="relative">
                  <img
                    src={authenticatedUser.picture || "/placeholder.svg?height=40&width=40&text=User"}
                    alt={authenticatedUser.name}
                    className="w-12 h-12 rounded-full object-cover border-3 border-white shadow-xl group-hover:shadow-2xl transition-all duration-300"
                  />
                  <div className="absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-3 border-white animate-pulse shadow-lg"></div>
                </div>
                <div className="hidden sm:flex flex-col">
                  <span className="text-sm font-bold text-gray-800">{authenticatedUser.name}</span>
                  <span className="text-xs text-gray-500">{authenticatedUser.email}</span>
                </div>
              </button>
            </div>
          ) : (
            <div className="flex items-center gap-3">
              <Button className="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white h-12 px-6 rounded-xl shadow-xl font-bold transition-all duration-300 hover:shadow-2xl hover:scale-105" onClick={() => { window.location.href = '/api/auth/google' }}>
                GoogleÎ°ú Î°úÍ∑∏Ïù∏
              </Button>
            </div>
          )}
        </div>
      </div>

      {/* Î©îÏù∏ Ïª®ÌÖêÏ∏† */}
      <div className="p-6 space-y-6 pb-20 relative z-10 max-w-4xl mx-auto">
        {/* ÏÉÅÌÉú Î©îÏãúÏßÄ */}
                 {authenticatedUser ? (
           <div className={`bg-gradient-to-r from-blue-500/8 via-indigo-500/6 to-purple-500/8 backdrop-blur-xl border border-blue-200/30 rounded-3xl p-6 shadow-2xl cursor-default transition-all duration-1000 delay-300 ${
             isPageLoaded ? 'translate-y-0 opacity-100' : 'translate-y-8 opacity-0'
           }`}>
             <div className="flex items-center gap-4">
               <div className="flex-1">
                 <h3 className={`text-lg font-black text-gray-900 mb-2 transition-all duration-1000 delay-700 ${
                   isPageLoaded ? 'translate-x-0 opacity-100' : 'translate-x-4 opacity-0'
                 }`}>ÏïàÎÖïÌïòÏÑ∏Ïöî, {userInfo.name}Îãò! {getStatusMessage().icon}</h3>
                 <div className={`transition-all duration-1000 delay-900 ${
                   isPageLoaded ? 'translate-x-0 opacity-100' : 'translate-x-4 opacity-0'
                 }`}>
                   <div 
                     key={`title-${statusMessageKey}`}
                     className={`text-sm font-bold mb-1 transition-all duration-500 ease-out ${
                       getStatusMessage().title === "ÌèâÍ∞Ä ÏôÑÎ£å" 
                         ? "text-green-700 font-black text-base animate-pulse" 
                         : "text-gray-800 animate-pulse"
                     }`}
                     style={{
                       animation: 'slideInFade 0.5s ease-out forwards',
                       opacity: 0,
                       transform: 'translateX(8px)'
                     }}
                   >
                     {getStatusMessage().title}
                   </div>
                   <div 
                     key={`message-${statusMessageKey}`}
                     className="text-sm text-gray-600 leading-tight transition-all duration-1000 ease-out"
                     style={{
                       animation: 'slideInFade 0.8s ease-out 0.3s forwards',
                       opacity: 0,
                       transform: 'translateX(12px) scale(0.98)',
                     }}
                   >
                     {getStatusMessage().message}
                   </div>
                                       {/* Í≤∞Í≥º ÌôïÏù∏ Î≤ÑÌäº Ï†úÍ±∞ - My PageÎ°ú Ïó∞Í≤∞ÎêòÏñ¥ ÏÜåÏö©ÏóÜÏùå */}
                 </div>
               </div>
             </div>
           </div>
         ) : (
           <div className={`bg-gradient-to-r from-amber-500/8 via-orange-500/6 to-red-500/8 backdrop-blur-xl border border-amber-200/30 rounded-3xl p-6 shadow-2xl cursor-default transition-all duration-1000 delay-300 ${
             isPageLoaded ? 'translate-y-0 opacity-100' : 'translate-y-8 opacity-0'
           }`}>
             <div className="flex items-center gap-4">
               <div className={`bg-gradient-to-br from-amber-500 to-orange-500 p-3 rounded-2xl shadow-xl transition-all duration-1000 delay-500 ${
                 isPageLoaded ? 'rotate-0 scale-100' : 'rotate-12 scale-90'
               }`}>
                 <LogIn className="w-5 h-5 text-white" />
               </div>
               <div className="flex-1">
                 <h3 className={`text-lg font-black text-gray-900 mb-1 transition-all duration-1000 delay-700 ${
                   isPageLoaded ? 'translate-x-0 opacity-100' : 'translate-x-4 opacity-0'
                 }`}>Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§ üîê</h3>
                 <p className={`text-sm text-gray-600 leading-tight transition-all duration-1000 delay-900 ${
                   isPageLoaded ? 'translate-x-0 opacity-100' : 'translate-x-4 opacity-0'
                 }`}>ÏÑúÎπÑÏä§Î•º Ïù¥Ïö©ÌïòÎ†§Î©¥ Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.</p>
               </div>
             </div>
           </div>
         )}

        {/* Í∏∞Îä• Ïπ¥ÎìúÎì§ */}
        <div className="grid gap-6">
          {/* ÎÖπÏùå ÌååÏùº Ï†úÏ∂ú Ïπ¥Îìú */}
          <Card 
            className={`bg-gradient-to-br from-white via-blue-50/30 to-indigo-50/20 shadow-2xl rounded-2xl border border-white/50 card-hover cursor-pointer overflow-hidden group ${
              isPageLoaded ? 'translate-y-0 opacity-100' : 'translate-y-12 opacity-0'
            }`}
            style={{ transitionDelay: '1100ms' }}
            onClick={(e) => handleCardClick("fileUpload", e)}
          >
            <div className="absolute inset-0 bg-gradient-to-r from-blue-500/3 via-indigo-500/2 to-purple-500/3 opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none"></div>
            <CardContent className="p-8 relative">
              <div className="flex items-center gap-6">
                <div className="bg-gradient-to-br from-blue-600 via-indigo-600 to-purple-600 p-5 rounded-2xl shadow-2xl group-hover:shadow-3xl transition-all duration-500 subtle-float">
                  <Mic className="w-10 h-10 text-white" />
                </div>
                <div className="flex-1">
                  <h3 className="text-xl font-black text-gray-900 mb-2">ÎÖπÏùå ÌååÏùº Ï†úÏ∂ú</h3>
                  <p className="text-gray-600 text-sm mb-4 leading-relaxed">
                    Î∂ÄÏÇ∞Î≤†Ïù¥Ïä§ Ï†ÑÏö© ÏóÖÎ°úÎìú ÌéòÏù¥ÏßÄÏûÖÎãàÎã§.
                  </p>
                  <div className="flex items-center gap-3">
                    <Badge className="bg-gradient-to-r from-blue-600 to-indigo-600 text-white border-0 text-xs font-bold px-3 py-1 shadow-lg">
                      <Mic className="w-3 h-3 mr-1" />
                      PUS Base Only
                    </Badge>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>

          {/* ÎÇ¥ ÏùëÏãú ÎÇ¥Ïó≠ Ïπ¥Îìú */}
          <Card 
            className={`bg-gradient-to-br from-white via-green-50/30 to-emerald-50/20 shadow-2xl rounded-2xl border border-white/50 card-hover cursor-pointer overflow-hidden group ${
              isPageLoaded ? 'translate-y-0 opacity-100' : 'translate-y-12 opacity-0'
            } ${shouldEmphasizeReviewCard ? 'attention-pulse ring-2 ring-orange-400' : ''}`}
            style={{ transitionDelay: '1300ms' }}
            onClick={(e) => handleCardClick("review", e)}
          >
            <div className="absolute inset-0 bg-gradient-to-r from-green-500/3 via-emerald-500/2 to-teal-500/3 opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none"></div>
            <CardContent className="p-8 relative">
              <div className="flex items-center gap-6">
                <div className="bg-gradient-to-br from-green-600 via-emerald-600 to-teal-600 p-5 rounded-2xl shadow-2xl group-hover:shadow-3xl transition-all duration-500 subtle-float">
                  <BookOpen className="w-10 h-10 text-white" />
                </div>
                <div className="flex-1">
                  <h3 className="text-xl font-black text-gray-900 mb-2">Í≤∞Í≥º ÌôïÏù∏</h3>
                  <p className="text-gray-600 text-sm mb-4 leading-relaxed">
                    Ïù¥Ï†ÑÏóê Ï†úÏ∂úÌïú ÌèâÍ∞Ä Í≤∞Í≥ºÎ•º ÌôïÏù∏Ìï©ÎãàÎã§.
                  </p>
                  <div className="flex items-center gap-3">
                    <Badge className="bg-gradient-to-r from-green-600 to-emerald-600 text-white border-0 text-xs font-bold px-3 py-1 shadow-lg">
                      <History className="w-3 h-3 mr-1" />
                      Review
                    </Badge>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>
        </div>

      </div>

      {/* ÌïòÎã® Í≥†Ï†ï Ï†ïÎ≥¥ - Î∞∞Í≤ΩÏóê ÏûêÏó∞Ïä§ÎüΩÍ≤å ÎÖπÏïÑÎì§ÎèÑÎ°ù */}
      <div className="fixed bottom-0 left-0 right-0 pointer-events-none z-0">
        <div className={`text-center pb-8 transition-all duration-1000 delay-[1500ms] ${
          isPageLoaded ? 'translate-y-0 opacity-100' : 'translate-y-8 opacity-0'
        }`}>
          <p className={`text-sm font-bold text-gray-700/90 mb-1 transition-all duration-1000 delay-[1900ms] ${
            isPageLoaded ? 'translate-y-0 opacity-100' : 'translate-y-2 opacity-0'
          }`}>
            JVOICE v1.0 Mobile
          </p>
          <p className={`text-xs text-gray-500/80 mb-3 transition-all duration-1000 delay-[2100ms] ${
            isPageLoaded ? 'translate-y-0 opacity-100' : 'translate-y-2 opacity-0'
          }`}>
            ‚ìí 2025 Jin Air Cabin Training Group
          </p>
          <div className={`flex justify-center gap-2 transition-all duration-1000 delay-[2300ms] ${
            isPageLoaded ? 'translate-y-0 opacity-100' : 'translate-y-2 opacity-0'
          }`}>
            <div className="w-2 h-2 bg-lime-500 rounded-full animate-pulse shadow-lg"></div>
            <div className="w-2 h-2 bg-blue-800 rounded-full animate-pulse shadow-lg" style={{ animationDelay: '0.5s' }}></div>
            <div className="w-2 h-2 bg-teal-300 rounded-full animate-pulse shadow-lg" style={{ animationDelay: '1s' }}></div>
          </div>
        </div>
      </div>

      {/* Î°úÍ∑∏Ïù∏ Î™®Îã¨ */}
      {showLoginModal && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-xl w-full max-w-md">
            <div className="p-6">
              <div className="text-center mb-6">
                <h2 className="text-xl font-bold text-gray-900 mb-2">Î°úÍ∑∏Ïù∏</h2>
                <p className="text-gray-600">ÏÑúÎπÑÏä§Î•º Ïù¥Ïö©ÌïòÎ†§Î©¥ Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.</p>
              </div>
              <GoogleAuth onAuthSuccess={handleAuthSuccess} />
              <Button
                onClick={() => setShowLoginModal(false)}
                variant="outline"
                className="w-full mt-3"
              >
                Ï∑®ÏÜå
              </Button>
            </div>
          </div>
        </div>
      )}

      {/* My Page Î™®Îã¨ */}
      {showMyPage && (
        <MobileMyPageModal
          user={authenticatedUser || null}
          userInfo={userInfo}
          onClose={() => setShowMyPage(false)}
          onLogout={handleLogout}
          isLoggingOut={isLoggingOut}
        />
      )}
    </div>
  )
}

// Î™®Î∞îÏùºÏö© MyPage Î™®Îã¨ Ïª¥Ìè¨ÎÑåÌä∏
function MobileMyPageModal({
  user,
  userInfo,
  onClose,
  onLogout,
  isLoggingOut,
}: {
  user: AuthenticatedUser | null
  userInfo: UserInfo
  onClose: () => void
  onLogout: () => void
  isLoggingOut: boolean
}) {
  const [activeTab, setActiveTab] = useState<"profile" | "qualifications">("profile")
  const [employeeData, setEmployeeData] = useState<any>(null)
  const [loading, setLoading] = useState(false)

  // ÏßÅÏõê ÏûêÍ≤© Ï†ïÎ≥¥ Î∂àÎü¨Ïò§Í∏∞
  useEffect(() => {
    const loadEmployeeQualifications = async () => {
      if (user?.email) {
        setLoading(true)
        try {
          // Ï∫êÏãúÎ•º Î¨¥ÏãúÌïòÍ≥† ÏÉàÎ°úÏö¥ Îç∞Ïù¥ÌÑ∞Î•º Í∞ïÏ†úÎ°ú Î∂àÎü¨Ïò§Í∏∞
          await employeeDB.refreshEmployeeData()
          const employeeInfo = await employeeDB.findEmployeeByEmail(user.email)
          console.log("üîç [MobileMyPageModal] ÏßÅÏõê Ï†ïÎ≥¥ Î°úÎìú:", employeeInfo)
          setEmployeeData(employeeInfo)
        } catch (error) {
          console.error("ÏßÅÏõê ÏûêÍ≤© Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®:", error)
        } finally {
          setLoading(false)
        }
      }
    }
    loadEmployeeQualifications()
  }, [user?.email])

  // ÏûêÍ≤© Îì±Í∏âÏóêÏÑú ÏïåÌååÎ≤≥Îßå Ï∂îÏ∂úÌïòÎäî Ìï®Ïàò
  const extractGrade = (gradeString: string) => {
    if (!gradeString) return "-"
    // ANNC_X, JP_X, CN_X ÌòïÌÉúÏóêÏÑú X Î∂ÄÎ∂ÑÎßå Ï∂îÏ∂ú
    const match = gradeString.match(/(?:ANNC_|JP_|CN_)?([A-Z])/)
    return match ? match[1] : gradeString
  }

  // ÏûêÍ≤© Îì±Í∏âÎ≥Ñ Ïä§ÌÉÄÏùº Ìï®Ïàò
  const getGradeStyle = (grade: string) => {
    const cleanGrade = extractGrade(grade)
    switch (cleanGrade) {
      case "S":
        return "bg-yellow-500 text-white font-bold"
      case "A":
        return "bg-blue-500 text-white font-bold"
      case "B":
        return "bg-green-500 text-white font-semibold"
      default:
        return "bg-gray-300 text-gray-700"
    }
  }

  // ÏÇ¨Ïö©ÏûêÏùò Ï£ºÏöî Ïó≠Ìï†ÏùÑ Î∞òÌôòÌïòÎäî Ìï®Ïàò (Ïö∞ÏÑ†ÏàúÏúÑ: Í¥ÄÎ¶¨Ïûê > ÍµêÍ¥Ä)
  const getUserMainRole = () => {
    if (userInfo.isAdmin) return "Í¥ÄÎ¶¨Ïûê"
    if (userInfo.isInstructor) return "ÍµêÍ¥Ä"
    return null
  }

  // ESC ÌÇ§ Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨
  useEffect(() => {
    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === "Escape") {
        onClose();
      }
    };

    document.addEventListener("keydown", handleEscape);
    return () => {
      document.removeEventListener("keydown", handleEscape);
    };
  }, [onClose]);

  return (
    <div 
      className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"
      tabIndex={0}
      onKeyDown={e => {
        if (e.key === "Escape") onClose();
      }}
      autoFocus
    >
      <div className="bg-white rounded-2xl shadow-xl w-full max-w-md max-h-[90vh] overflow-hidden relative">
        {/* Ìó§Îçî */}
        <div className="bg-gray-50 p-4 border-b border-gray-200">
          <div className="flex items-center justify-between">
            <h2 className="text-lg font-bold text-gray-900">My Account</h2>
            <button onClick={onClose} className="p-2 hover:bg-gray-200 rounded-lg">
              <X className="w-4 h-4" />
            </button>
          </div>

          {/* ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */}
          <div className="flex mt-4 bg-white rounded-lg p-1">
            <button
              onClick={() => setActiveTab("profile")}
              className={`flex-1 text-center px-3 py-2 rounded-md text-sm font-medium transition-colors ${
                activeTab === "profile"
                  ? "bg-blue-100 text-blue-700"
                  : "text-gray-600 hover:bg-gray-100"
              }`}
            >
              ÌîÑÎ°úÌïÑ Ï†ïÎ≥¥
            </button>
            <button
              onClick={() => setActiveTab("qualifications")}
              className={`flex-1 text-center px-3 py-2 rounded-md text-sm font-medium transition-colors ${
                activeTab === "qualifications"
                  ? "bg-blue-100 text-blue-700"
                  : "text-gray-600 hover:bg-gray-100"
              }`}
            >
              Î∞©ÏÜ° ÏûêÍ≤©
            </button>
          </div>
        </div>

        {/* Ïª®ÌÖêÏ∏† */}
        <div className="p-4 overflow-y-auto max-h-[calc(90vh-120px)]">
          {activeTab === "profile" && (
            <div className="bg-white rounded-xl shadow-lg p-6 flex flex-col items-center border border-blue-100">
              <div className="relative mb-6">
                <div className="w-20 h-20 rounded-full overflow-hidden border-4 border-blue-200 shadow-lg bg-white flex items-center justify-center">
                  <img
                    src={user?.picture || "/placeholder.svg?height=80&width=80&text=User"}
                    alt={user?.name}
                    className="w-full h-full object-cover"
                  />
                </div>
                {getUserMainRole() && (
                  <span className={`absolute -bottom-1 -right-1 text-white font-bold px-3 py-1 rounded-full shadow-lg text-sm tracking-wider border-2 ${
                    getUserMainRole() === "Í¥ÄÎ¶¨Ïûê"
                      ? "bg-gradient-to-r from-orange-400 to-red-500 border-orange-300"
                      : "bg-gradient-to-r from-green-400 to-blue-500 border-blue-300"
                  }`}>
                    {getUserMainRole()}
                  </span>
                )}
              </div>
              <div className="w-full text-center mb-4">
                <h4 className="text-xl font-bold text-gray-900 mb-1">{user?.name}</h4>
                <p className="text-sm text-gray-500 mb-2">{user?.email}</p>
              </div>
              <div className="w-full space-y-3">
                <div className="flex justify-between items-center">
                  <span className="text-gray-600 font-medium">ÏÇ¨Î≤à</span>
                  <span className="text-gray-900 font-bold">{userInfo.employeeId || user?.broadcastCode}</span>
                </div>
                <div className="flex justify-between items-center">
                  <span className="text-gray-600 font-medium">ÎùºÏù∏ÌåÄ</span>
                  <span className="text-gray-900 font-bold">{userInfo.department || '-'}</span>
                </div>
                <div className="flex justify-between items-center">
                  <span className="text-gray-600 font-medium">Î∞©ÏÜ°ÏΩîÎìú</span>
                  <span className="text-gray-900 font-bold">{userInfo.position || '-'}</span>
                </div>
              </div>
            </div>
          )}

          {activeTab === "qualifications" && (
            <div className="space-y-4">
              <div className="text-center mb-4">
                <h3 className="text-lg font-bold text-gray-900 mb-1">{userInfo.name}({userInfo.employeeId}) Î∞©ÏÜ° ÏûêÍ≤© ÌòÑÌô©</h3>
                <p className="text-sm text-gray-600">{new Date().toLocaleString('ko-KR', { 
                  year: 'numeric', 
                  month: '2-digit', 
                  day: '2-digit', 
                  hour: '2-digit', 
                  minute: '2-digit'
                })}</p>
              </div>

              {loading ? (
                <div className="text-center py-8">
                  <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mb-3"></div>
                  <p className="text-gray-600 text-sm">ÏûêÍ≤© Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ëÏûÖÎãàÎã§...</p>
                </div>
              ) : (
                <div className="space-y-3">
                  {/* Ìïú/ÏòÅ ÏûêÍ≤© */}
                  <div className="bg-white rounded-lg shadow-md border border-gray-100 p-4">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 bg-gradient-to-br from-slate-600 to-slate-800 rounded-full flex items-center justify-center shadow-md">
                          <span className="text-sm text-white">üá∞üá∑üá∫üá∏</span>
                        </div>
                        <div>
                          <h4 className="text-base font-semibold text-gray-900">ÌïúÍµ≠Ïñ¥/ÏòÅÏñ¥</h4>
                          <p className="text-xs text-gray-600">
                            {employeeData?.koreanEnglishExpiry ? `Ïú†Ìö®Í∏∞Í∞Ñ: ${employeeData.koreanEnglishExpiry}` : "Ïú†Ìö®Í∏∞Í∞Ñ Ï†ïÎ≥¥ ÏóÜÏùå"}
                          </p>
                        </div>
                      </div>
                      <div className={`px-3 py-1 rounded-full text-base font-bold shadow-md ${getGradeStyle(employeeData?.koreanEnglishGrade || "")}`}>
                        {extractGrade(employeeData?.koreanEnglishGrade || "")}
                      </div>
                    </div>
                  </div>

                  {/* ÏùºÎ≥∏Ïñ¥ ÏûêÍ≤© */}
                  <div className="bg-white rounded-lg shadow-md border border-gray-100 p-4">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 bg-gradient-to-br from-slate-600 to-slate-800 rounded-full flex items-center justify-center shadow-md">
                          <span className="text-sm text-white">üáØüáµ</span>
                        </div>
                        <div>
                          <h4 className="text-base font-semibold text-gray-900">ÏùºÎ≥∏Ïñ¥</h4>
                        </div>
                      </div>
                      <div className={`px-3 py-1 rounded-full text-base font-bold shadow-md ${getGradeStyle(employeeData?.japaneseGrade || "")}`}>
                        {extractGrade(employeeData?.japaneseGrade || "")}
                      </div>
                    </div>
                  </div>

                  {/* Ï§ëÍµ≠Ïñ¥ ÏûêÍ≤© */}
                  <div className="bg-white rounded-lg shadow-md border border-gray-100 p-4">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 bg-gradient-to-br from-slate-600 to-slate-800 rounded-full flex items-center justify-center shadow-md">
                          <span className="text-sm text-white">üá®üá≥</span>
                        </div>
                        <div>
                          <h4 className="text-base font-semibold text-gray-900">Ï§ëÍµ≠Ïñ¥</h4>
                        </div>
                      </div>
                      <div className={`px-3 py-1 rounded-full text-base font-bold shadow-md ${getGradeStyle(employeeData?.chineseGrade || "")}`}>
                        {extractGrade(employeeData?.chineseGrade || "")}
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          )}
        </div>

        {/* ÌïòÎã® Î°úÍ∑∏ÏïÑÏõÉ Î≤ÑÌäº */}
        <div className="p-4 border-t border-gray-200 bg-gray-50">
          <Button onClick={onLogout} disabled={isLoggingOut} variant="outline" className="w-full">
            {isLoggingOut ? (
              <>
                <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                Î°úÍ∑∏ÏïÑÏõÉ Ï§ë...
              </>
            ) : (
              <>
                <LogOut className="w-4 h-4 mr-2" />
                Î°úÍ∑∏ÏïÑÏõÉ
              </>
            )}
          </Button>
        </div>
      </div>
    </div>
  )
}
